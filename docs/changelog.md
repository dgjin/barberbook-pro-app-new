# BarberBook Pro 更新日志 (Changelog)

所有系统变更、功能更新及修复将在此记录。

## [2026-02-23] - UI 视觉设计全面优化

### 更新摘要
对全站设计体系进行了系统性的视觉升级，优化了色彩搭配、字体层级和排版节奏，打造更专业、更温暖、更舒适的用户体验。

### 变更清单

#### 1. 设计体系升级 (index.html)
- **主色优化**：从 `#007AFF` (iOS 蓝) 调整为 `#2563EB` (更沉稳的蓝色600)，新增辅助色 `primary-light` 和 `accent` (琥珀色)。
- **字体引入**：新增 Outfit 作为标题展示字体 (`font-display`)，与 Inter 正文字体形成品牌层级。
- **背景色暖化**：从冷灰 `#F2F2F7` 调整为暖白 `#F8FAFC`。
- **字体渲染**：启用亚像素抗锯齿 (`antialiased`) 和 OpenType 特性优化。

#### 2. 全页面排版优化
- **字重降级**：全局从 `font-black` (900) 降至 `font-extrabold` (800) / `font-bold` (700)，减少视觉侵略性。
- **标签字号提升**：全局 `text-[10px]` 标签统一提升至 `text-[11px]`，改善可读性。
- **字间距松弛**：从极密 `tracking-[0.2em]`/`tracking-[0.3em]` 统一为 `tracking-widest`/`tracking-wider`，更自然。

#### 3. 页面级优化
- **登录页** (Login.tsx)：标题改用 Outfit 字体 5xl；输入框增加细边框 + 柔和 focus 效果；CTA 按钮使用蓝色渐变。
- **注册页** (Register.tsx)：标题使用 display 字体；输入框增加边框；提交按钮使用暗色渐变。
- **首页** (CustomerHome.tsx)：section 标题使用 display 字体；CTA 按钮渐变化；探索空间卡片描述字号提升。
- **顾客中心** (CheckIn.tsx)：用户卡片信息字号提升；权益栏标签优化。
- **预约页** (Booking.tsx)：全页面降重优化；确认弹窗标题使用 display 字体；理发师详情统计标签字号提升。
- **理发师工作台** (Workbench.tsx)：品牌标识使用 display 字体；菜单降重至 semibold。
- **管理后台** (Management.tsx)：页面标题使用 display 字体；按钮排版优化。

## [2026-02-22] - 性能优化、统计增强与导航修复

### 更新摘要
本次更新聚焦于理发师工作台的性能平滑度、数据准确性以及跨角色导航的稳定性。

### 变更清单

#### 1. 核心性能优化
- **原子化结算 RPC**：新增 `complete_barber_service_v2` 数据库函数，将原有的 5+ 次顺序数据库调用合并为单个原子事务。
- **结账速度提升**：重构 `useBarberAppointments` 钩子，调用原子 RPC 后结账响应速度提升约 80-90%，并实现日志异步写入。
- **Schema 更新**：在 `app_barbers` 表中增加了 `voucher_revenue` 字段，以支持精确的理发券营收统计。

#### 2. 系统稳定性修复
- **实时链路递归修复**：修复了 `useRealtime` 和 `useMultiRealtime` 钩子中由于通道销毁逻辑导致的无限递归（Maximum call stack size exceeded）错误。

#### 3. 理发师工作台增强
- **精准排班统计**：引入 `useBarberSaturation` 钩子，将负载统计从前端本地模拟升级为后端 7 天数据驱动，确保预约预测完全准确。
- **工作台集成**：在 `Workbench.tsx` 中全面集成真实统计视图。

#### 4. 路由与角色系统修复
- **动态角色同步**：修复了监控页 (`Monitor.tsx`) 和大屏模式 (`WebMonitor.tsx`) 中角色硬编码的问题，确保理发师进入监控屏后底栏导航保持正确。
- **智能导航返回**：修正了理发师退出监控大屏时的跳转路径，使其能够准确返回理发师工作台而非顾客首页。
- **类型安全**：修复了相关页面中缺失 `User` 类型定义的 Lint 错误。

#### 5. 鉴权闭环系统 (Security Milestone)
- **移除免密登录**：彻底废弃了 `RoleLauncher` 中点击头像即登录的非安全逻辑。
- **多表认证引擎**：重构 `useAuth` 钩子，支持跨 `app_customers`、`app_barbers`、`app_admins` 三张表的统一身份核验。
- **Schema 结构升级**：数据库 `app_barbers` 已补齐登录凭证字段，并新增了持久化的管理员表 `app_admins`。
- **动态登录界面**：`Login` 页面现在能根据角色入口自动切换 UI 风格、验证字段（手机号/用户名）及错误处理逻辑。

#### 7. 全能登录与全域密码管控 (Universal Auth & Password System)
- **极简全能登录**：重构 `useAuth.ts`，引入**启发式智能识别逻辑**（`管理员 -> 理发师 -> 顾客`），移除所有手动选角入口，实现单一账号/手机号盲登。
- **全域密码重置**：在 `Management.tsx` 中为管理员注入跨表重置权限，支持一键重置（初始密码 `123456`）及管理员个人凭据在线修改。
- **交互边界优化**：全面清理了 `Login.tsx` 与 `RoleLauncher.tsx` 中的旧有分栈逻辑，并将应用首页默认路由重定向至 `/login`，显著提升了直达效率。

#### 8. 管理后台数据完整性增强 (Data Schema Enrichment)
- **理发师资料增强**：在理发师档案中引入了 `phone` 字段管理，支持管理员在后台直接维护发型师的联系信息与登录凭证。

#### 9. 全角色自助服务系统 (Self-Service Pro)
- **顾客中心增强**：在 `CheckIn.tsx` 中上线了资料编辑与密码重置模态框，支持头像即时预览。
- **理发师名片中心**：在 `Workbench.tsx` 中注入了理发师专用的“个人设置”模块，支持职级、简介、专业领域标签及登录凭证的安全变更。
- **底层统一接口**：在 `useAuth.ts` 中打通了跨三表的 `updateProfile` 和 `updatePassword` 异步原子操作。

- **理发师资料中心显隐一致性**：解决了设置模态框打开时初始资料为空的延迟问题。
- **注销体验修正**：统一了理发师端注销逻辑，注销后精准返回登录页面，杜绝误入顾客端首页。
- **全量数据载荷**：补全了 `User` 类型定义及鉴权链路的数据抓取，确保理发师职级、简介等核心信息全球同步。

#### 10. 全角色信息维护一体化 (Unified Profile Center)
- **顾客端整合 (CheckIn.tsx)**：资料编辑模态框新增"真实姓名"与"电子邮箱"字段；密码修改从独立弹窗合并为折叠式安全区域。
- **理发师端整合 (Workbench.tsx)**：密码修改从独立模态框合并进资料维护页面底部的折叠式安全区域；设置菜单简化为单一"个人中心"入口。
- **管理员端整合 (Management.tsx)**：管理员列表中的 `prompt` 弹窗密码修改替换为正式的"我的设置"编辑面板，内含折叠式密码修改表单。
- **交互规范统一**：三端信息维护页面均采用统一的折叠式密码区域设计，所有 Input 增加空值回退逻辑（`|| ""`），消除 React 受控组件警告。

## [2026-02-22] - 语音叫号系统规则优化 (Voice Announcement System Enhancement)

### 更新摘要
重构了监控大屏的语音播报逻辑，实现更智能的叫号策略和全局队列管理，提升多理发师并发场景下的播报体验。

### 紧急修复 (Hotfix)
**问题**: 优化后语音播报功能异常，无法正常叫号
**原因**: 
- 函数定义顺序导致闭包问题，useEffect 中的回调无法正确访问最新定义的函数
- `addToGlobalQueue` 等函数在 `useEffect` 之后定义，但在 `useEffect` 回调执行时引用错误
- `isProcessingRef` 等状态管理存在竞态条件

**解决方案**:
- 重写 `WebMonitor.tsx`，简化函数结构，确保所有函数在组件作用域内正确定义
- 使用 `useRef` 统一管理所有播报状态（`announcedIdsRef`、`pendingQueueRef`、`currentServingRef`、`globalQueueRef`、`isProcessingRef`）
- 简化 TTS 实现，直接使用浏览器原生 `speechSynthesis` API
- 添加详细的调试日志（console.log），便于排查问题
- 确保 `audioEnabledRef` 正确同步到 TTS 函数

**语音合成引擎 (TTS Engine)**:
- **引擎**: 科大讯飞 (iFLYTEK) 云语音合成
- **发音人**: 聆小旋 (xiaoxuan) - 大气宣传片风格女声
- **特点**: 声音饱满、专业播音级音质、适合商业场所叫号
- **音频格式**: 16kHz PCM/WAV 高品质输出

**测试验证**:
1. 打开监控大屏 (`/web-monitor`)
2. 点击"点击开启系统叫号"按钮，确认听到"语音系统已就绪"测试音（大气男声）
3. 顾客签到：
   - 如果理发师空闲，应立即听到叫号语音（低沉男声）
   - 如果理发师忙碌，应加入队列不播报
4. 理发师完成服务后2秒，应自动播报队列中下一位顾客
5. 理发师点击"呼叫下一位"，应立即播报

### 变更清单

#### 1. 智能播报触发规则 (Smart Trigger Rules)
- **空闲叫号**: 客户签到时，若理发师处于空闲状态，立即触发语音播报
- **排队叫号**: 客户签到时，若理发师正在服务，加入待播报队列，等待当前服务完成后播报
- **完成触发**: 理发师点击"确认完成并结算"后，自动播报该理发师队列中的下一位客户
- **主动呼叫**: 理发师点击"呼叫下一位"按钮，立即触发播报

#### 2. 全局队列顺序播报 (Global Sequential Queue)
- **全局队列管理**: 新增 `globalAnnouncementQueueRef` 管理所有播报请求
- **防重叠机制**: 使用 `isProcessingAnnouncementRef` 确保同一时间只播报一条消息
- **顺序执行**: 多理发师同时触发时，按进入队列的顺序依次播报，间隔 500ms
- **来源标记**: 每条播报记录标记来源类型（`idle_checkin`/`complete`/`call_next`），便于日志追踪

#### 3. 持久化防重复 (Deduplication)
- **SessionStorage 持久化**: 已播报的客户 ID 保存至 `sessionStorage`，防止页面刷新后重复播报
- **内存去重**: `announcedIdsRef` 运行时内存去重，确保同一会话内不重复播报

#### 4. 跨页面广播机制 (BroadcastChannel)
- **理发师 → 监控屏通信**: 使用 `BroadcastChannel('barberbook_call_next')` 实现工作台到监控屏的实时通信
- **解耦设计**: 理发师点击"呼叫下一位"时广播消息，监控屏接收后统一进入全局队列

#### 5. 文件变更
- **WebMonitor.tsx**: 
  - 新增 `processGlobalQueue()` 全局队列处理函数
  - 新增 `playAnnouncementSync()` 同步播报 Promise 函数
  - 新增 `addToGlobalQueue()` 全局队列添加函数
  - 重构实时订阅逻辑，实现智能触发规则
- **Workbench.tsx**: 
  - `handleCallNext` 函数增加 BroadcastChannel 消息发送

### 播报流程示例
```
场景1: 空闲理发师接待
客户A签到 → 检测到王师傅空闲 → 立即播报:"请客户A到王师傅处..."

场景2: 忙碌理发师排队
客户B签到 → 检测到李师傅忙碌 → 加入队列（不播报）
           → 李师傅完成服务 → 延迟2秒 → 播报:"请客户B到李师傅处..."

场景3: 多理发师并发
王师傅完成 → 客户C加入全局队列
李师傅同时完成 → 客户D加入全局队列
播报顺序:
  1. "请客户C到王师傅处..."（第1个入队）
  2. 间隔500ms
  3. "请客户D到李师傅处..."（第2个入队）
```

---

*注：后续更新将持续在此记录。*
