# BarberBook Pro 更新日志 (Changelog)

所有系统变更、功能更新及修复将在此记录。

## [2026-02-23] - UI 视觉设计全面优化

### 更新摘要
对全站设计体系进行了系统性的视觉升级，优化了色彩搭配、字体层级和排版节奏，打造更专业、更温暖、更舒适的用户体验。

### 变更清单

#### 1. 设计体系升级 (index.html)
- **主色优化**：从 `#007AFF` (iOS 蓝) 调整为 `#2563EB` (更沉稳的蓝色600)，新增辅助色 `primary-light` 和 `accent` (琥珀色)。
- **字体引入**：新增 Outfit 作为标题展示字体 (`font-display`)，与 Inter 正文字体形成品牌层级。
- **背景色暖化**：从冷灰 `#F2F2F7` 调整为暖白 `#F8FAFC`。
- **字体渲染**：启用亚像素抗锯齿 (`antialiased`) 和 OpenType 特性优化。

#### 2. 全页面排版优化
- **字重降级**：全局从 `font-black` (900) 降至 `font-extrabold` (800) / `font-bold` (700)，减少视觉侵略性。
- **标签字号提升**：全局 `text-[10px]` 标签统一提升至 `text-[11px]`，改善可读性。
- **字间距松弛**：从极密 `tracking-[0.2em]`/`tracking-[0.3em]` 统一为 `tracking-widest`/`tracking-wider`，更自然。

#### 3. 页面级优化
- **登录页** (Login.tsx)：标题改用 Outfit 字体 5xl；输入框增加细边框 + 柔和 focus 效果；CTA 按钮使用蓝色渐变。
- **注册页** (Register.tsx)：标题使用 display 字体；输入框增加边框；提交按钮使用暗色渐变。
- **首页** (CustomerHome.tsx)：section 标题使用 display 字体；CTA 按钮渐变化；探索空间卡片描述字号提升。
- **顾客中心** (CheckIn.tsx)：用户卡片信息字号提升；权益栏标签优化。
- **预约页** (Booking.tsx)：全页面降重优化；确认弹窗标题使用 display 字体；理发师详情统计标签字号提升。
- **理发师工作台** (Workbench.tsx)：品牌标识使用 display 字体；菜单降重至 semibold。
- **管理后台** (Management.tsx)：页面标题使用 display 字体；按钮排版优化。

## [2026-02-22] - 性能优化、统计增强与导航修复

### 更新摘要
本次更新聚焦于理发师工作台的性能平滑度、数据准确性以及跨角色导航的稳定性。

### 变更清单

#### 1. 核心性能优化
- **原子化结算 RPC**：新增 `complete_barber_service_v2` 数据库函数，将原有的 5+ 次顺序数据库调用合并为单个原子事务。
- **结账速度提升**：重构 `useBarberAppointments` 钩子，调用原子 RPC 后结账响应速度提升约 80-90%，并实现日志异步写入。
- **Schema 更新**：在 `app_barbers` 表中增加了 `voucher_revenue` 字段，以支持精确的理发券营收统计。

#### 2. 系统稳定性修复
- **实时链路递归修复**：修复了 `useRealtime` 和 `useMultiRealtime` 钩子中由于通道销毁逻辑导致的无限递归（Maximum call stack size exceeded）错误。

#### 3. 理发师工作台增强
- **精准排班统计**：引入 `useBarberSaturation` 钩子，将负载统计从前端本地模拟升级为后端 7 天数据驱动，确保预约预测完全准确。
- **工作台集成**：在 `Workbench.tsx` 中全面集成真实统计视图。

#### 4. 路由与角色系统修复
- **动态角色同步**：修复了监控页 (`Monitor.tsx`) 和大屏模式 (`WebMonitor.tsx`) 中角色硬编码的问题，确保理发师进入监控屏后底栏导航保持正确。
- **智能导航返回**：修正了理发师退出监控大屏时的跳转路径，使其能够准确返回理发师工作台而非顾客首页。
- **类型安全**：修复了相关页面中缺失 `User` 类型定义的 Lint 错误。

#### 5. 鉴权闭环系统 (Security Milestone)
- **移除免密登录**：彻底废弃了 `RoleLauncher` 中点击头像即登录的非安全逻辑。
- **多表认证引擎**：重构 `useAuth` 钩子，支持跨 `app_customers`、`app_barbers`、`app_admins` 三张表的统一身份核验。
- **Schema 结构升级**：数据库 `app_barbers` 已补齐登录凭证字段，并新增了持久化的管理员表 `app_admins`。
- **动态登录界面**：`Login` 页面现在能根据角色入口自动切换 UI 风格、验证字段（手机号/用户名）及错误处理逻辑。

#### 7. 全能登录与全域密码管控 (Universal Auth & Password System)
- **极简全能登录**：重构 `useAuth.ts`，引入**启发式智能识别逻辑**（`管理员 -> 理发师 -> 顾客`），移除所有手动选角入口，实现单一账号/手机号盲登。
- **全域密码重置**：在 `Management.tsx` 中为管理员注入跨表重置权限，支持一键重置（初始密码 `123456`）及管理员个人凭据在线修改。
- **交互边界优化**：全面清理了 `Login.tsx` 与 `RoleLauncher.tsx` 中的旧有分栈逻辑，并将应用首页默认路由重定向至 `/login`，显著提升了直达效率。

#### 8. 管理后台数据完整性增强 (Data Schema Enrichment)
- **理发师资料增强**：在理发师档案中引入了 `phone` 字段管理，支持管理员在后台直接维护发型师的联系信息与登录凭证。

#### 9. 全角色自助服务系统 (Self-Service Pro)
- **顾客中心增强**：在 `CheckIn.tsx` 中上线了资料编辑与密码重置模态框，支持头像即时预览。
- **理发师名片中心**：在 `Workbench.tsx` 中注入了理发师专用的“个人设置”模块，支持职级、简介、专业领域标签及登录凭证的安全变更。
- **底层统一接口**：在 `useAuth.ts` 中打通了跨三表的 `updateProfile` 和 `updatePassword` 异步原子操作。

- **理发师资料中心显隐一致性**：解决了设置模态框打开时初始资料为空的延迟问题。
- **注销体验修正**：统一了理发师端注销逻辑，注销后精准返回登录页面，杜绝误入顾客端首页。
- **全量数据载荷**：补全了 `User` 类型定义及鉴权链路的数据抓取，确保理发师职级、简介等核心信息全球同步。

#### 10. 全角色信息维护一体化 (Unified Profile Center)
- **顾客端整合 (CheckIn.tsx)**：资料编辑模态框新增"真实姓名"与"电子邮箱"字段；密码修改从独立弹窗合并为折叠式安全区域。
- **理发师端整合 (Workbench.tsx)**：密码修改从独立模态框合并进资料维护页面底部的折叠式安全区域；设置菜单简化为单一"个人中心"入口。
- **管理员端整合 (Management.tsx)**：管理员列表中的 `prompt` 弹窗密码修改替换为正式的"我的设置"编辑面板，内含折叠式密码修改表单。
- **交互规范统一**：三端信息维护页面均采用统一的折叠式密码区域设计，所有 Input 增加空值回退逻辑（`|| ""`），消除 React 受控组件警告。

*注：后续更新将持续在此记录。*
